<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>The story</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<hr>
<div class="paragraph">
<p>title: "Designing an API Client in Rust: New RSpotify Version a Year Later"
description: "Inspired by the RSpotify rewrite, a few tips on how to make a
solid wrapper for most web API wrappers."
author: "Mario Ortiz Manero"
images: ["/blog/web-api-client/crate_hierarchy.png"]
tags: ["tech", "programming", "rust", "open source"]
keywords: ["programming", "rust", "rustlang", "open source", "rspotify", "web api"]
date: 2021-10-13
series: ["rspotify"]
GHissueID: 2
---</p>
</div>
<div class="paragraph">
<p>This article in <a href="https://nullderef.com/series/rspotify">the Rspotify series</a>
describes my journey of basically rewriting the entirety of
<a href="https://github.com/ramsayleung/rspotify">this Rust library</a>; around 13 months of
work (in my free time), starting at September 2020, up until October 2021. I
think this has given me enough experience for an article regarding API design on
Rust, and perhaps those who attempt the same in the future can take some ideas
and save time. Specially considering how much I&#8217;ve gone in circles and how much
time I&#8217;ve &#8220;wasted&#8221; implementing things that ended up being discarded.</p>
</div>
<div class="sect1">
<h2 id="_the_story">The story</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you don&#8217;t care about RSpotify&#8217;s specific story, you can jump to the
``<a href="#actual_start">Making the API HTTP-client agnostic</a>'' section, but I think knowing a bit the motives for this
rewrite is interesting for other open source maintainers in the same situation
as me. This all started when I wanted to use a Rust Spotify API wrapper for one
of my projects at that time, <a href="https://vidify.org/">Vidify</a>. I went to
<a href="https://crates.io/">crates.io</a> and looked for &#8220;Spotify&#8221;, and all I found was
{{&lt; crate rspotify &gt;}} (the most popular one), {{&lt; crate aspotify &gt;}} (an
asynchronous-only alternative), and a bunch of other outdated or incomplete
libraries.</p>
</div>
<div class="paragraph">
<p>The author of <code>aspotify</code> had made a brand-new library from scratch, because as
he commented in its release, &#8220;[rspotify&#8217;s] API in general I found hard to use
and confusing&#8221; <a href="#aspotify-release">[1]</a>. Honestly, depending on the state of the
original library this is the easiest choice because you don&#8217;t have to worry
about backwards compatibility or old code.</p>
</div>
<div class="paragraph">
<p>A year back I had also helped with the first steps of
<a href="https://github.com/felix-hilden/tekore"><code>tekore</code></a>, an alternative to
<a href="https://github.com/plamere/spotipy"><code>spotipy</code></a>, the most popular Spotify library
for Python out there. The problem was that back then, Paul, spotipy&#8217;s creator
and maintainer, was absent <a href="#spotipy-absent">[2]</a>, and the library really needed a
push to upgrade from Python 2 and improve the overall interface and
user-friendliness, which had become pretty poor.</p>
</div>
<div class="paragraph">
<p>A few devs, including <a href="https://github.com/felix-hilden">Felix</a>, tried to start
from scratch. Felix was the most dedicated, and Paul eventually granted him
permissions to upload new spotipy releases, meaning that he could rewrite the
entire thing under the same name, and upload it to PyPi (Python&#8217;s official
third-party repositories) if he wanted to. The problem was that spotipy had a
good amount of users by that point. A couple of them ended up stopping Felix
from completely breaking backward compatibility, so he made it into a brand-new
library instead and left the maintainance tasks to the new devs in charge.
Tekore still is, in my very biased opinion and at the time of this writing, a
much nicer to use library than spotipy. But it has taken a lot of time to get a
user base starting from scratch, and it&#8217;s still not as popular as spotipy by
far.</p>
</div>
<div class="paragraph">
<p>Having gone through this, I also wanted to see if it would be possible to give
RSpotify a face wash without anyone complaining. RSpotify was still in beta&#8201;&#8212;&#8201;version 0.10&#8201;&#8212;&#8201;so you can&#8217;t expect to have a stable API, but that&#8217;s far from a
full rewrite. At the very least I wanted to talk with Ramsay, the original
RSpotify developer, and see what his thoughts were. I proposed some big changes
like rewriting the <code>blocking</code> module <a href="#gh-block-cleanup">[3]</a> and
<a href="https://github.com/Kestrer">Kestrer</a> wrote up an issue with ~80 issues he had
found when using the library <a href="#gh-meta">[4]</a>.</p>
</div>
<div class="paragraph">
<p>I think it&#8217;s fair to release the new version 0.11 as such, rather than as a new
library, for the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ramsay, the author, also wanted to help.</p>
</li>
<li>
<p>The fundamentals of the library would remain the same: being the most
user-friendly feature-full library for the Spotify API.</p>
</li>
<li>
<p>It was considered a necessary evil. In my opinion, the library was doomed
without a big rewrite. Otherwise, it&#8217;d eventually become really hard to
maintain and work with. I admit that said breaking changes could&#8217;ve been
smaller, but I thought that, while I&#8217;m at it, I might as well make it as close
as possible to a perfect Rust interface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, note that I am in no way associated with Spotify (though open to offers
:P). I&#8217;m just a Computer Science student whose sole goal was to use Rust for a
non-trivial case, from start to finish. I was somewhat experienced with the
Spotify API, so I decided RSpotify was a good choice.</p>
</div>
<div class="paragraph">
<p>Now that most of the stuff I talk about in this article is finished, you can
read about the changes in detail
<a href="https://github.com/ramsayleung/rspotify/blob/master/CHANGELOG.md">in the
CHANGELOG</a>. The following sections will talk about what I learned about API
Design, and some tips for those writing one in Rust.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="actual_start">Making the API HTTP-client agnostic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RSpotify is now HTTP-client agnostic, which means that it can work with
whichever HTTP library the user configures without adding much overhead. For
now, we support {{&lt; crate ureq &gt;}} and {{&lt; crate reqwest &gt;}} <a href="#gh-clients">[5]</a>. The
non-trivial part about this is that the HTTP client can be either blocking
(<code>ureq</code>) or asynchronous (<code>reqwest</code>).</p>
</div>
<div class="paragraph">
<p>While it&#8217;s fully implemented in the new version, it&#8217;s the only part that isn&#8217;t
finished yet and that&#8217;s subject to change. This has to do with the way we
support both async and sync HTTP clients under the same trait. In order to have
a common interface for both kinds of programming, we use the {{&lt; crate
maybe_async &gt;}} crate, which lets us switch between them with a feature.</p>
</div>
<div class="paragraph">
<p>The trait used as a base for any HTTP client is implemented with async. That
way, if the <code>maybe_async/is_sync</code> feature is disabled in the <code>Cargo.toml</code>, the
trait and its implementations remain the same, and if it&#8217;s enabled, all the
occurrences of <code>async</code> and <code>.await</code> are removed. It&#8217;s also possible to add
special cases where removing <code>async</code>/<code>.await</code> isn&#8217;t enough. This works
perfectly, but unfortunately breaks a rule in Cargo&#8217;s feature system: features
must be strictly additive, and <code>maybe_async</code>'s feature is a <em>toggle</em>&#8201;&#8212;&#8201;you
can&#8217;t have both a sync and an async client at the same time.</p>
</div>
<div class="paragraph">
<p>Since we don&#8217;t follow that rule, those who depend on RSpotify with both async
and sync (directly or indirectly) won&#8217;t be able to compile their project. I
won&#8217;t get into much detail because I&#8217;m writing an entire separate post dedicated
for this issue that I&#8217;ll publish once this whole ordeal is fixed. We&#8217;re keeping
track of it in <a href="https://github.com/ramsayleung/rspotify/issues/221">#221</a> for now,
for those who want to learn more.</p>
</div>
<div class="paragraph">
<p>For now, I&#8217;ll just explain how it works for clients of the same type: either
synchronous or asynchronous. Since the usage for an HTTP client in an API is
often very basic, i.e., you only need to make requests and get the results, we
can cover its usage under a single interface. For example:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
pub trait HttpClient: Send + Default {
   type Error;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fn get(
    &amp;self,
    url: &amp;str,
    headers: Option&lt;&amp;Headers&gt;,
    payload: &amp;Query,
) -&gt; Result&lt;String, Self::Error&gt;;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fn post(
    &amp;self,
    url: &amp;str,
    headers: Option&lt;&amp;Headers&gt;,
    payload: &amp;Value,
) -&gt; Result&lt;String, Self::Error&gt;;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    // etc
}
{{&lt; /highlight &gt;}}</pre>
</div>
</div>
<div class="paragraph">
<p>Then, we can add an implementation for each of our supported clients:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
pub struct UreqClient {}</p>
</div>
<div class="paragraph">
<p>impl HttpClient for UreqClient {
    type Error = ureq::Transport;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#[inline]
fn get(
    &amp;self,
    url: &amp;str,
    headers: Option&lt;&amp;Headers&gt;,
    payload: &amp;Query,
) -&gt; Result&lt;String, Self::Error&gt; {
    let request = ureq::get(url);
    let sender = |mut req: Request| {
        for (key, val) in payload.iter() {
            req = req.query(key, val)
        }
        req.call()
    };
    self.request(request, headers, sender) // Internal more complex handler
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    // etc
}
{{&lt; /highlight &gt;}}</pre>
</div>
</div>
<div class="paragraph">
<p>And we can finally make our client generic over its internal HTTP client:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
pub struct Spotify&lt;Http: HttpClient&gt; {
    http: Http,
    // etc
}</p>
</div>
<div class="paragraph">
<p>impl&lt;Http: HttpClient&gt; Spotify&lt;Http&gt; {
    pub fn endpoint(&amp;self) &#8594; String {
        let headers = todo!();
        let payload = todo!();
        self.http.get("/some/endpoint", headers, payload)
    }
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>Beware that this introduces a good amount of additional complexity which is
probably unnecessary for your own API wrapper. But this was definitely something
interesting for RSpotify: some crates that already depend on us like
<a href="https://github.com/hrkfdn/ncspot"><code>ncspot</code></a> or
<a href="https://github.com/Spotifyd/spotifyd"><code>spotifyd</code></a> are blocking, and others like
<a href="https://github.com/Rigellute/spotify-tui"><code>spotify-tui</code></a> use async. I thought I
might as well try, and I&#8217;ve finally figured out how to make it work, even for
both async and sync.</p>
</div>
<div class="paragraph">
<p>We implement all of this in the crate
<a href="https://github.com/ramsayleung/rspotify/tree/master/rspotify-http"><code>rspotify-http</code></a>,
which I plan on <a href="https://github.com/ramsayleung/rspotify/issues/234">moving into a
separate crate</a> for the whole community to use once it&#8217;s working as I want it
to. I think this is a pretty neat feature for an API client that will hopefully
become easier to implement in the future (and first of all work properly).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_finding_a_more_robust_architecture">Finding a more robust architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another key refactor I worked on for RSpotify was its architecture. The Spotify
API in particular has
<a href="https://developer.spotify.com/documentation/general/guides/authorization-guide/">multiple
authorization methods</a> that give you access to a different set of endpoints. For
example, if you&#8217;re using <em>client credentials</em> (the most basic one), then you
can&#8217;t access an endpoint to modify the user&#8217;s data; you need
<a href="https://en.wikipedia.org/wiki/OAuth">OAuth information</a>. This used to work with
the <a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html"><em>builder
pattern</em></a>, following this structure (though not exactly the same):</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let oauth = SpotifyOAuth::default()
    .redirect_uri("http://localhost:8888/callback")
    .scope("user-modify-playback-state")
    .build()
    .unwrap();</p>
</div>
<div class="paragraph">
<p>let creds = SpotifyClientCredentials::default()
    .client_id("this-is-my-client-id")
    .client_secret("this-is-my-client-secret")
    .build()
    .unwrap();</p>
</div>
<div class="paragraph">
<p>let token = get_token(&amp;mut oauth).unwrap();</p>
</div>
<div class="paragraph">
<p>let spotify = Spotify::default()
    .client_credentials_manager(creds)
    .token_info(token)
    .build()
    .unwrap();</p>
</div>
<div class="paragraph">
<p>spotify.seek_track(25000, None).unwrap();
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>I wanted something more tailored towards our specific application. I think the
builder pattern is great, but it might become too verbose or confusing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do we really need it for <code>Credentials</code>, which always takes the same two
parameters?</p>
</li>
<li>
<p>Which authorization method are we using above again? Currently, it&#8217;s possible
to call <code>seek_track</code> after having followed an authorization process that
doesn&#8217;t give access to it. And since we&#8217;re mixing all of them under the same
client it quickly becomes a mess, having many <code>Option&lt;T&gt;</code> fields that are only
<code>Some</code> for specific authorization methods. So, what if we have a Spotify
client for each authorization method?</p>
</li>
<li>
<p>Wouldn&#8217;t it be nice to have some type safety, too? The <code>unwrap</code> hurts my eyes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After removing the builder pattern and being more explicit about the
authorization method that&#8217;s being used, this is more or less what we get:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let oauth = OAuth::new("http://localhost:8888/callback", "user-read-currently-playing");
let creds = Credentials::new("my-client-id", "my-client-secret");
let mut spotify = AuthCodeSpotify::new(creds, oauth);</p>
</div>
<div class="paragraph">
<p>spotify.prompt_for_token().unwrap();</p>
</div>
<div class="paragraph">
<p>spotify.seek_track(25000, None).unwrap();
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>And if the user wants something more advanced, they can always write this:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let oauth = OAuth {
    redirect_uri: "http://localhost:8888/callback",
    state: generate_random_string(16, alphabets::ALPHANUM),
    scopes: "user-read-currently-playing",
    ..Default::default()
};
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>It&#8217;s sufficient to use the regular initialization pattern for this case because
we don&#8217;t even need validation. If we did, we could always just add a few setters
or checks before its usage and we&#8217;re done. Ask yourself: do you really need the
builder pattern? In this case we certainly didn&#8217;t.</p>
</div>
<div class="paragraph">
<p>The most complicated part of the refactor is having a client for each
authorization method, and making sure the user can only call those endpoints
they have access to. There are <em>many</em> ways to approach this, I just had to
decide which one was the best. I gave this a lot of thought <a href="#gh-auth">[6]</a>
<a href="#reddit-auth">[7]</a>.</p>
</div>
<div class="paragraph">
<p>Having multiple clients seems trivial with inheritance, with a base from which
they can extend. In Rust, we could follow the typical &#8220;composition over
inheritance&#8221; principle:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
pub struct EndpointsBase {
    http: Rc&lt;Http&gt; // Shared with the rest of the endpoints
}
impl EndpointsBase {
    pub fn endpoint1(&amp;self) { self.http.get("/endpoint1") }
    pub fn endpoint2(&amp;self) { self.http.get("/endpoint2") }
    // etc
}</p>
</div>
<div class="paragraph">
<p>pub struct EndpointsOAuth {
    token: Token,
    http: Rc&lt;Http&gt;
}
impl EndpointsOAuth {
    pub fn endpoint3(&amp;self) { self.http.get_oauth("/endpoint3", self.token) }
    pub fn endpoint4(&amp;self) { self.http.get_oauth("/endpoint4", self.token) }
    // etc
}</p>
</div>
<div class="paragraph">
<p>pub struct AuthCodeSpotify(EndpointsBase, EndpointsOAuth);
impl AuthCodeSpotify {
    pub fn authenticate(&amp;self) { /* &#8230;&#8203; */ }</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    pub fn base(&amp;self) -&gt; &amp;EndpointsBase { &amp;self.0 }
    pub fn oauth(&amp;self) -&gt; &amp;EndpointsOAuth { &amp;self.1 }
}
{{&lt; /highlight &gt;}}</pre>
</div>
</div>
<div class="paragraph">
<p>The user can then write <code>spotify.base().endpoint1()</code> or
<code>spotify.oauth().endpoint3()</code> to access the endpoints in their different groups.
However, all of them have to share a single HTTP client and other information
such as the config or the token, so we have to use something like <code>Rc</code>. We can
improve this by taking ideas from {{&lt; crate aspotify &gt;}}, another popular crate
for the Spotify API, which groups up the endpoints by categories. Their endpoint
groups take a reference to the client itself instead, which is pretty neat and
works just as well:</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=6cce195451518fcf644e7506ca7b51b2">Simplified from the working example on the Rust playground</a></div>
<p>{{&lt; highlight "rust" &gt;}}
pub trait Spotify {
    fn get_http(&amp;self) &#8594; &Http;
    fn get_token(&amp;self) &#8594; &Token;
}</p>
</div>
<div class="paragraph">
<p>pub struct EndpointsBase&lt;'a, S: Spotify&gt;(&amp;'a S);
impl&lt;S: Spotify&gt; EndpointsBase&lt;'_, S&gt; {
    pub fn endpoint1(&amp;self) { self.0.get_http().get("/endpoint1") }
    pub fn endpoint2(&amp;self) { self.0.get_http().get("/endpoint2") }
    // etc
}</p>
</div>
<div class="paragraph">
<p>pub struct EndpointsOAuth&lt;'a, S: Spotify&gt;(&amp;'a S);
impl&lt;S: Spotify&gt; EndpointsOAuth&lt;'_, S&gt; {
    pub fn endpoint3(&amp;self) { self.0.get_http().get_oauth("/endpoint3", self.0.get_token()) }
    pub fn endpoint4(&amp;self) { self.0.get_http().get_oauth("/endpoint4", self.0.get_token()) }
    // etc
}</p>
</div>
<div class="paragraph">
<p>pub struct AuthCodeSpotify {
    pub http: Http,
    pub token: Token
}
impl Spotify for AuthCodeSpotify {
    fn get_http(&amp;self) &#8594; &amp;Http { &amp;self.http }
    fn get_token(&amp;self) &#8594; &amp;Token { &amp;self.token }
}
impl AuthCodeSpotify {
    pub fn authenticate(&amp;self) { /* &#8230;&#8203; */ }</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    pub fn base(&amp;self) -&gt; EndpointsBase&lt;'_, Self&gt; { EndpointsBase(self) }
    pub fn oauth(&amp;self) -&gt; EndpointsOAuth&lt;'_, Self&gt; { EndpointsOAuth(self) }
}
{{&lt; /highlight &gt;}}</pre>
</div>
</div>
<div class="paragraph">
<p>However, you might think using just <code>spotify.endpoint1()</code> instead of
<code>spotify.base().endpoint1()</code> is more suitable for your particular API client.
The only way to do that would be to delegate every single endpoint manually into
the main client. Some people use <code>Deref</code> and <code>DerefMut</code> in order to
automatically do it, but that&#8217;s a common anti-pattern <a href="#deref-antipattern">[8]</a>.</p>
</div>
<div class="paragraph">
<p>I tried different approaches, and my favorite ended up being a trait-based
interface. All you need is a couple traits with the endpoint implementations,
which require a getter to the HTTP client or similars:</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=901e41d16172e17368328c5a7744f673">Simplified from the working example on the Rust playground</a></div>
<p>{{&lt; highlight "rust" &gt;}}
pub trait EndpointsBase {
    fn get_http(&amp;self) &#8594; &Http;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    fn endpoint1(&amp;self) { self.get_http().get("/endpoint1") }
    fn endpoint2(&amp;self) { self.get_http().get("/endpoint2") }
    // etc
}</pre>
</div>
</div>
<div class="paragraph">
<p>pub trait EndpointsOAuth: EndpointsBase {
    fn get_token(&amp;self) &#8594; &Token;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    fn endpoint3(&amp;self) { self.get_http().get_oauth("/endpoint3", self.get_token()) }
    fn endpoint4(&amp;self) { self.get_http().get_oauth("/endpoint4", self.get_token()) }
    // etc
}</pre>
</div>
</div>
<div class="paragraph">
<p>pub struct AuthCodeSpotify(Http, Token);
impl AuthCodeSpotify {
    pub fn authenticate(&amp;self) { /* &#8230;&#8203; */ }
}
impl EndpointsBase for AuthCodeSpotify {
    fn get_http(&amp;self) &#8594; &amp;Http { &amp;self.0 }
}
impl EndpointsOAuth for AuthCodeSpotify {
    fn get_token(&amp;self) &#8594; &amp;Token { &amp;self.1 }
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>This way, as long as the user has these traits in scope, they can access the
endpoints with just <code>spotify.endpoint1()</code>. We can make that easier by including
a <a href="https://stackoverflow.com/questions/36384840/what-is-the-prelude">prelude</a> in
the library with these traits, so that all the user has to do is <code>use
rspotify::prelude::*</code>. Another big advantage this provides is that it&#8217;s
extremely flexible. The user can declare their own client and implement its
internal functionality themselves, while still having access to the endpoints,
which is the boring task that probably doesn&#8217;t need customization. And even if
they wanted to, they could just override the trait implementation.</p>
</div>
<div class="paragraph">
<p>The main issue with the trait-based solution is that you can&#8217;t use <code>-&gt; impl
Trait</code> in trait methods as of Rust 1.55 <a href="#trait-ret-impl">[9]</a>. We unfortunately
need these, specially with asynchronous clients, because async trait methods are
<code>-&gt; impl Future</code> after all. For now, we can work around it by erasing the types
with the {{&lt; crate async-trait &gt;}} crate. Supposedly, this will be temporary
until GATs are implemented, which isn&#8217;t too far off <a href="#gats">[10]</a>.</p>
</div>
<div class="paragraph">
<p>Both of these solutions also make it hard to have private functions in the base
client, because the shared parts are in a trait. We don&#8217;t really want the user
to have access to the methods <code>get</code> or <code>get_oauth</code>. It&#8217;s defined in the
client/trait because it&#8217;s useful for every client, but for the end user it&#8217;s
just noise in the documentation. This isn&#8217;t that much of a big deal because you
can just declare the item with <code>#[doc(hidden)]</code> so that it doesn&#8217;t appear in the
documentation.</p>
</div>
<div class="paragraph">
<p>So yeah, there are no <em>perfect</em> solutions, but these are two of the best ones I
could find. The choice is up to the designer of the library and their needs.
Having multiple clients let us implement PKCE Authentication for RSpotify quite
easily <a href="#gh-pkce">[11]</a>, so it&#8217;s worth it in the end anyway. Our final architecture
looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/blog/web-api-client/trait_hierarchy.png" alt="trait hierarchy">
</div>
<div class="title">Figure 1. Diagram by Ramsay</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_runtime_over_compile_time">Runtime over compile-time</h3>
<div class="paragraph">
<p>There are a few parts of the Spotify client that can be customized by the user.
Previously, these were just fields of the main client, but since we now have
multiple clients, it might be worth moving into a separate struct to avoid
duplication.</p>
</div>
<div class="paragraph">
<p>Anyhow, one of our fails was attempting to use features instead of the <code>Config</code>
struct for configuration, on the assumption that features would be more
performant:</p>
</div>
<div class="paragraph">
<div class="title">Which is faster?</div>
<p>{{&lt; highlight "rust" &gt;}}
if self.config.cached_token {
    println!("Saving cache token to the file!");
}</p>
</div>
<div class="paragraph">
<p>#[cfg(feature = "cached_token")]
{
    println!("Saving cache token to the file!");
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>Turns out that both of these are usually compiled to the same machine code
anyway. Since <code>self.config.cached_token</code> is most times specified as a constant,
optimizing it away is one of the more basic tasks a compiler can do. Features
are drastically less flexible and harder to use than runtime variables, so
before introducing one you should really think about it. Apart from the fact
that you obviously can&#8217;t use features at runtime (which is a possible use-case
here), they are applied globally, so you can&#8217;t have two different clients, one
with cached tokens and another without them. In order to take this decision I
actually wrote an entire article about it, so
<a href="https://nullderef.com/blog/rust-features/">check it out if you want more
details</a>.</p>
</div>
<div class="paragraph">
<p>Even though it&#8217;s basic, I keep forgetting about this: don&#8217;t get obsessed with
performance. As you add new features to the crate, it&#8217;s completely natural that
some overheads are introduced here and there. And even then, they might not even
be noticeable. First of all get that new feature working. Then, measure the real
effect on performance. And finally, if it&#8217;s more than you expected, then
actually think about optimizing it.</p>
</div>
<div class="paragraph">
<p>One correct usage would be our new <code>cli</code> feature. We have some utilities for
command-line programs, such as prompting for the user&#8217;s credentials. However,
not everyone needs these, such as servers, and it introduced the {{&lt; crate
webbrowser &gt;}} dependency and a few unnecessary functions. So we decided to move
this into a separate feature for those interested, which is disabled by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sane_defaults">Sane defaults</h3>
<div class="paragraph">
<p>On the topic of configuration, it&#8217;s important to have sane defaults as well.
This is highly subjective, but I prefer to do as little as possible under the
hood <em>without the user knowing about it</em>. When initializing a client we used to
automatically try to read from the environment variables. If that didn&#8217;t work
then we tried to use the default values or we just panicked in the builder:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let creds = SpotifyClientCredentials::default() // this reads the env variables
    .client_id("this-is-my-client-id")
    .client_secret("this-is-my-client-secret")
    .build()
    .unwrap();
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>This is a pretty useful feature, but we can&#8217;t be sure the writer/reader of the
code knows about it, and it could potentially cause unintended behaviour.
Instead, we can just have a <code>default</code> method that does nothing special, which is
what the user would expect, and also <code>from_env</code>, which <em>explicitly</em> tells us
what it does:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let creds = SpotifyClientCredentials::from_env() // this reads the env variables
    .client_id("this-is-my-client-id")
    .client_secret("this-is-my-client-secret")
    .build()
    .unwrap();
{{&lt; /highlight &gt;}}</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flexibility">Flexibility</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_taking_borrowedgeneric_parameters">Taking borrowed/generic parameters</h3>
<div class="paragraph">
<p>Friendly reminder: generally, it&#8217;s better to take a <code>&amp;str</code> than a <code>String</code> in a
function <a href="#str-param">[12]</a> <a href="#gh-iterators">[13]</a>. The same thing applies to the owned
type <code>Vec&lt;T&gt;</code>; it&#8217;s probably a better idea to take a <code>&amp;[T]</code> instead, or the even
more fancy <code>impl IntoIterator&lt;Item = T&gt;</code>. The last option makes it possible to
pass iterators to the function without requiring a <code>collect</code>, which not only is
more user-friendly, but also avoids a memory allocation. Its only downside is
that the function signatures become a bit uglier, and all the consequences of
using generics. Either of these options are fine, really, so it&#8217;s up to you.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optional_parameters">Optional parameters</h3>
<div class="paragraph">
<p>Similarly, if the functions in your library frequently include optional
parameters (i.e., of type <code>Option&lt;T&gt;</code>), you might want to consider other ways to
handle them. In our case, we were using generics with <code>Into&lt;Option&lt;T&gt;&gt;</code> in order
to not have to wrap the parameters in <code>Some</code> when passing them to the function,
but it wasn&#8217;t consistent. We finally agreed that using plain <code>Option&lt;T&gt;</code> was
good enough because it simplifies the function definition in the docs and it&#8217;s
less magic <a href="#gh-optional-params">[14]</a>. But the important part is that we made it
<em>consistent</em>; the decision itself between <code>Into&lt;Option&lt;T&gt;&gt;</code> or <code>Option&lt;T&gt;</code>
wasn&#8217;t that important. After doing research about this topic, I wrote up an
article with more details <a href="https://nullderef.com/blog/rust-parameters/">here</a>, in
case you want to learn more.</p>
</div>
</div>
<div class="sect2">
<h3 id="_splitting_up_into_multiple_crates">Splitting up into multiple crates</h3>
<div class="paragraph">
<p>Another cool idea that promotes flexibility is separating the wrapper into
multiple crates. In RSpotify, we now have a total of four of them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rspotify-http</code>: the multi-HTTP client abstraction, which I plan on making
more generic and moving into a separate crate for everyone to use
<a href="#gh-http-universal">[15]</a></p>
</li>
<li>
<p><code>rspotify-macros</code>: a small crate with macros</p>
</li>
<li>
<p><code>rspotify-model</code>: the full model for the RSpotify crate</p>
</li>
<li>
<p><code>rspotify</code>: the implementation of the clients</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/blog/web-api-client/crate_hierarchy.png" alt="crate hierarchy">
</div>
<div class="title">Figure 2. Diagram by Ramsay</div>
</div>
<div class="paragraph">
<p>The most important one here is splitting up the wrapper into the model and the
clients. The model is generic enough that it can be used by any client, even
outside RSpotify. Some users have to implement their own custom clients for
different reasons, and pulling our model helps to avoid lots of complexity and
maintainance work <a href="#model-separation">[16]</a>. It can also be shared with other public
crates, such as <code>aspotify</code>, and join forces in keeping the model up to date
<a href="#gh-aspotify-share">[17]</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_documentation">Documentation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducing_how_to_use_the_crate">Introducing how to use the crate</h3>
<div class="paragraph">
<p>This might be obvious to some, but it isn&#8217;t enough to document every single
public item in your library. You also have to introduce the user how to work
with it in the top-level documentation. Some ideas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List the goals, current and future features of the crate, and things you don&#8217;t
plan working on. Perhaps also add a comparison with similar crates; these are
usually super helpful.</p>
</li>
<li>
<p>Write a small getting started guide, explaining the most important items in
the crate and what they do.</p>
</li>
<li>
<p>Add some notes about the architecture of your crate. This is specially useul
to those who want to contribute. For RSpotify, Ramsay created the diagrams
included in this article, and added more details in the
<a href="https://github.com/ramsayleung/rspotify/blob/master/README.md">README</a>.</p>
</li>
<li>
<p>Explain the Cargo features in your crate and how to use them.</p>
</li>
<li>
<p>Make sure you have a few examples working. It&#8217;s the easiest way to get
started, in my opinion.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_helping_users_upgrade">Helping users upgrade</h3>
<div class="paragraph">
<p>Since this change was going to break so much code, I wanted to make sure that
the upgrade is as less painful as possible. This can be achieved in many ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure you prove why these breaking changes are actually necessary. It will
feel like less of a waste of time to the user.</p>
</li>
<li>
<p>Include a
<a href="https://github.com/ramsayleung/rspotify/blob/master/CHANGELOG.md">changelog</a>,
either as an indepent file, or in the release notes. In RSpotify, we make
habit of adding a new line to the changelog for every release that includes a
new feature or breaking changes. To be honest, in our case it&#8217;s turned out
quite messy because we had <em>so many changes</em>, but in a regular update it
should be nicer to read.</p>
</li>
<li>
<p>It might be a good idea to
<a href="https://github.com/ramsayleung/rspotify/issues/218">create an issue in your
repository</a> where you provide help directly to those who try to upgrade and
have problems with it.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_macros">Macros</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Macros in Rust are pretty cool! But you don&#8217;t want to overdo them either. In
<code>rspotify</code> we frequently had to build hashmaps or JSON objects; at least once
per endpoint. Some of the parameters in the endpoints were mandatory, and others
optional (passed as an <code>Option</code>):</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let mut params = Query::with_capacity(3);
params.insert("ids", ids);
params.insert("limit", limit.to_string());
if let Some(ref market) = market {
    params.insert("market", market.as_ref());
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>I first tried to simplify this by using macros to their full strength, so my
initial attempts looked like this:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let params = build_map! {
    ids,
    limit &#8658; limit.to_string(),
    optional market &#8658; market.as_ref(),
};
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>Or this:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let params = build_map! {
    ids,
    limit &#8658; limit.to_string(),
    Some(market) &#8658; market.as_ref()
};
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>Yes, they are <em>very</em> concise and we remove a lot of boilerplate, but they&#8217;re bad
for two reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There&#8217;s too much magic going on:</p>
<div class="ulist">
<ul>
<li>
<p>They turn the <code>ids</code>/<code>limit</code>/<code>market</code> identifiers into a string with
<a href="https://doc.rust-lang.org/std/macro.stringify.html"><code>stringify!</code></a> and use that
as the key for the hashmap insertion.</p>
</li>
<li>
<p>In the expression to the right of an optional parameter, its value isn&#8217;t
treated as an <code>Option</code> anymore; there&#8217;s a hidden <code>if let Some(market)</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The syntax is weird. In order to understand them correctly, you&#8217;d probably
have to look up their documentation and read it first.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final design <a href="#gh-macros">[18]</a> still reduces the boilerplate needed in each
endpoint considerably, but there&#8217;s no magic going on. It&#8217;s basically the same as
a regular hashmap builder macro like you&#8217;d find on
<a href="https://docs.rs/maplit/1.0.2/maplit/"><code>maplit</code></a>, and the macro doesn&#8217;t hide
anything:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
let params = build_map! {
    "ids": ids,
    "limit": limit.to_string(),
    optional "market": market.map(|x| x.as_ref()),
};
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>Anyhow, we might remove it in the future, since this syntax will soon work as
well <a href="#hashmap-new">[19]</a>:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
HashMap::from([
  (k1, v1),
  (k2, v2)
]);
{{&lt; /highlight &gt;}}</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_goodies">Other goodies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some new features we added to RSpotify that might be of interest specifically
for other web API wrappers:</p>
</div>
<div class="sect2">
<h3 id="_cached_and_self_refreshing_tokens">Cached and self-refreshing tokens</h3>
<div class="paragraph">
<p>Cached tokens are automatically saved into a file, encoded for example in JSON,
and then attempted to be loaded again when restarting the application.</p>
</div>
<div class="paragraph">
<p>Before making a request, self-refreshing tokens check if they are expired, and
in that case perform the re-authorization process automatically.</p>
</div>
<div class="paragraph text-center">
<p>{{&lt; gh issue "ramsayleung/rspotify" 223 "Implement cache token and refresh token" &gt;}}</p>
</div>
</div>
<div class="sect2">
<h3 id="_type_safe_wrappers_for_id_types">Type-safe wrappers for ID types</h3>
<div class="paragraph">
<p>In the Spotify API, items such as artists or tracks are identified by a unique
ID string. The URI is the ID, but prefixed by its type, for example
<code>spotify:track:4cOdK2wGLETKBW3PvgPWqT</code>.</p>
</div>
<div class="paragraph">
<p>Many endpoints previously took the URI parameters as a String. That meant we had
to manually check that their type were what we were expecting, and also that
they were valid (they&#8217;re usually made up of alphanumeric characters).</p>
</div>
<div class="paragraph">
<p>Instead, we now have an <code>Id</code> trait and structs that implement it, like
<code>ArtistId</code> or <code>TrackId</code>, keeping its type known at compile time and also at
runtime with <code>dyn Id</code>. If you take a <code>TrackId</code> as a parameter, then you already
know its type, and that its contents are valid, so you&#8217;re ready to use it.</p>
</div>
<div class="paragraph text-center">
<p>{{&lt; gh pr "ramsayleung/rspotify" 161 "Initial id type proposal" &gt;}} and
{{&lt; gh pr "ramsayleung/rspotify" 244 "Fix IDs v4" &gt;}}</p>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_pagination">Automatic pagination</h3>
<div class="paragraph">
<p>Many API servers have paginated replies for large lists. Instead of sending a
huge object, it splits it up into multiple packets, and sends them one by one
along with an index to the position in the list. Then, the user can stop
requesting them at any time and potentially only end up using a portion of that
originally huge object.</p>
</div>
<div class="paragraph">
<p>In Rust, this can be abstracted away very naturally with
<a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">iterators</a> in sync
programs, and
<a href="https://rust-lang.github.io/async-book/05_streams/01_chapter.html">streams</a> for
async. The latter can be implemented easily in your crate thanks to {{&lt; crate
async_stream &gt;}}.</p>
</div>
<div class="paragraph text-center">
<p>{{&lt; gh issue "ramsayleung/rspotify" 124 "Add unlimited endpoints" &gt;}}</p>
</div>
</div>
<div class="sect2">
<h3 id="_simplify_wrapper_model_objects">Simplify wrapper model objects</h3>
<div class="paragraph">
<p>Due to how JSON works, sometimes an object will always have a single field:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "javascript" &gt;}}
{
    "many_artists": [
        {
            // ..
        },
        // &#8230;&#8203;
    ]
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph">
<p>In that case, instead of just deserializing that object with {{&lt; crate serde &gt;}}
and returning it to the user, you can just return that one field in the object:</p>
</div>
<div class="paragraph">
<p>{{&lt; highlight "rust" &gt;}}
#[derive(Deserialize)]
struct ArtistCollection {
    many_artists: Vec&lt;Artists&gt;
}</p>
</div>
<div class="paragraph">
<p>fn endpoint() &#8594; Result&lt;ArtistCollection&gt; {
    let response = request();
    serde_json::from_str(response)
}</p>
</div>
<div class="paragraph">
<p>fn endpoint() &#8594; Result&lt;Vec&lt;Artists&gt;&gt; {
    let response = request();
    serde_json::from_str::&lt;ArtistCollection&gt;(response).map(|x| x.many_artists)
}
{{&lt; /highlight &gt;}}</p>
</div>
<div class="paragraph text-center">
<p>{{&lt; gh issue "ramsayleung/rspotify" 149 "The way to reduce wrapper object" &gt;}}</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_measuring_the_changes">Measuring the changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since this release changed so much stuff and took so long, I wanted to get a
detailed comparison between v0.10 and v0.11 for different aspects of the
library&#8201;&#8212;&#8201;not just performance.</p>
</div>
<div class="paragraph">
<p>The full source for these benchmarks is available at the
<a href="https://github.com/marioortizmanero/rspotify-bench">marioortizmanero/rspotify-bench</a>
repository. Note that I had to apply a small patch to the v0.10 version because
by now it didn&#8217;t work correctly.</p>
</div>
<div class="sect2">
<h3 id="_statistics">Statistics</h3>
<div class="paragraph">
<p>Some parts of RSpotify can be analyzed statically, such as the lines of code
that will need to be maintained, or its number of dependencies:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Results example as of 2021-10-12</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">Rust LoC</th>
<th class="tableblock halign-left valign-top">Dependencies in tree</th>
<th class="tableblock halign-left valign-top">Dependencies in tree (all features)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.10.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11281</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">141</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">master</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7525</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">101</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Lines of Code in the old version were quite bloated because of the
<code>blocking</code> module, which was a copy-paste of the async client. Still, these were
lines that needed to be maintained, so they count just as much. On the other
hand, we now have a much more extensive set of tests and new features that add
up. In total, we have about 33% less lines to be maintained.</p>
</div>
<div class="paragraph">
<p>The number of dependencies has decreased both by default and with all the
features enabled. We cleaned up a lot of them and tried to keep the defaults
leaner <a href="#gh-cleanup">[20]</a>. Since the new version adds more features such as PKCE, we
even had to add new dependencies like {{&lt; crate sha2 &gt;}}, but it&#8217;s still a clear
win.</p>
</div>
</div>
<div class="sect2">
<h3 id="_execution_time">Execution time</h3>
<div class="paragraph">
<p>The execution benchmarks use
<a href="https://github.com/bheisler/criterion.rs">Criterion</a>, with a total of 100
iterations on my Dell Vostro 5481 laptop, or more specifically, Intel i5-8265U
(8) @ 3.900GHz. The full reports are available in the <code>report</code> directory of each
benchmark.</p>
</div>
<div class="paragraph">
<p>Taking a look at the Criterion reports, it seems that the Spotify API doesn&#8217;t
intentionally slow down responses when it&#8217;s being &#8220;spammed&#8221;, so it should be
fine in that regard:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/blog/web-api-client/iterations.png" alt="iterations">
</div>
</div>
<div class="paragraph">
<p>Note that comparing the blocking clients for now is unfair, because instead of
using <code>reqwest::blocking</code>, now it&#8217;s <code>ureq</code>. Furthermore, the async and sync
versions can&#8217;t be compared either, since the former requires setting up the
tokio runtime and a bunch of other stuff.</p>
</div>
<div class="paragraph">
<p>The asynchronous clients in both versions should give a rough idea of the actual
differences, though you can tell it&#8217;s just a quick benchmark, and the results
shouldn&#8217;t be taken too seriously in the first place:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Results example as of 2021-10-12</caption>
<colgroup>
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 17%;">
<col style="width: 16%;">
<col style="width: 15%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Version</th>
<th class="tableblock halign-center valign-top">Debug Compilation Time (s)</th>
<th class="tableblock halign-center valign-top">Release Compilation Time (s)</th>
<th class="tableblock halign-center valign-top">Benchmarking Time (ms/iter)</th>
<th class="tableblock halign-center valign-top">Release Binary Size (MB)</th>
<th class="tableblock halign-center valign-top">Release Stripped
Binary Size (MB)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0.10, blocking</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">72.7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">126.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">271.3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">9.9</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4.9</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0.10, async</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">72.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">115.7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">428.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">5.2</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0.11, blocking (ureq)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">38.5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">55.9</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">503.6</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">7.3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2.6</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0.11, async (reqwest)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">51.014</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">86.594</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">432.49</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8.5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>I also wanted to reflect the compilation time, since it&#8217;s a possibility that we
have less dependencies, but of larger size. The results show that this isn&#8217;t the
case, since it takes 29% less time to build in debug mode, and 25% less time in
release mode.</p>
</div>
<div class="paragraph">
<p>In terms of execution time, I didn&#8217;t expect it to be any better. Even though the
architecture and implementation is cleaner, some of the new features introduce
noticeable overhead. For example, now that we have automatically refreshing
tokens, the <code>Token</code> has to be saved in an <code>Arc&lt;Mutex&lt;T&gt;&gt;</code>, which means we&#8217;re
locking and unlocking at least once per request. Still, the difference is
negligible: just a 1% increase.</p>
</div>
<div class="paragraph">
<p>The cleanup and all these dependencies we removed mean that the resulting binary
is also smaller, and by a lot: there&#8217;s a 23% decrease in its size.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_special_thanks">Special thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This release has been possible thanks to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ramsayleung">@ramsayleung</a></p>
</li>
<li>
<p><a href="https://github.com/kstep">@kstep</a></p>
</li>
<li>
<p><a href="https://github.com/hellbound22">@hellbound22</a></p>
</li>
<li>
<p><a href="https://github.com/Qluxzz">@Qluxzz</a></p>
</li>
<li>
<p><a href="https://github.com/icewind1991">@icewind1991</a></p>
</li>
<li>
<p><a href="https://github.com/aramperes">@aramperes</a></p>
</li>
<li>
<p><a href="https://github.com/Sydpy">@Sydpy</a></p>
</li>
<li>
<p><a href="https://github.com/arlyon">@arlyon</a></p>
</li>
<li>
<p><a href="https://github.com/flip1995">@flip1995</a></p>
</li>
<li>
<p><a href="https://github.com/Rigellute">@Rigellute</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m specially grateful towards Ramsay, who apart from contributing many of the
features I listed here, read and reviewed <em>every single one of my issues and
pull requests</em>. I&#8217;ve learned how important it is to have a second opinon, and
someone else who proofreads everything before you merge dumb stuff into
<code>master</code>. Note that I <em>did</em> proofread my own ideas and pull requests, but there
are some things that you just don&#8217;t notice on time, as much as you try to. This
is a problem that I think is particularly relevant in open source. I personally
had worked on projects alone most of the time, and the difference is huge. I
would suggest everyone to try to join forces with at least one more person when
working in side projects.</p>
</div>
<div class="paragraph">
<p>That&#8217;s all! I hope this post provided insightful information and that you
learned something from it. Remember that you can leave a comment at the bottom
in case you want to discuss it.</p>
</div>
<div class="paragraph">
<p>Lots of love,<br>
Mario</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="aspotify-release"></a>[1]
<a href="https://www.reddit.com/r/rust/comments/ehz66s/aspotify_an_asynchronous_rust_spotify_web_api/">aspotify:
An asynchronous Rust Spotify web API client - r/rust</a></p>
</li>
<li>
<p><a id="spotipy-absent"></a>[2] {{&lt; gh issue "plamere/spotipy" 387 "Is under development?" &gt;}}</p>
</li>
<li>
<p><a id="gh-block-cleanup"></a>[3] {{&lt; gh issue "ramsayleung/rspotify" 112 "Cleaning up the blocking module" &gt;}}</p>
</li>
<li>
<p><a id="gh-meta"></a>[4] {{&lt; gh issue "ramsayleung/rspotify" 127 "Meta-Issue" &gt;}}</p>
</li>
<li>
<p><a id="gh-clients"></a>[5] {{&lt; gh pr "ramsayleung/rspotify" 129 "Multiple clients via features" &gt;}}</p>
</li>
<li>
<p><a id="gh-auth"></a>[6] {{&lt; gh issue "ramsayleung/rspotify" 173 "Restructure the authentication process" &gt;}}</p>
</li>
<li>
<p><a id="reddit-auth"></a>[7]
<a href="https://www.reddit.com/r/rust/comments/lkdw6o/designing_a_new_architecture_for_rspotify_based/">Designing
a new architecture for RSpotify based on trait inheritance, need opinions -
Reddit</a></p>
</li>
<li>
<p><a id="deref-antipattern"></a>[8]
<a href="https://github.com/rust-unofficial/patterns/blob/main/anti_patterns/deref.md"><code>Deref</code>
polymorphism</a></p>
</li>
<li>
<p><a id="trait-ret-impl"></a>[9]
<a href="https://stackoverflow.com/questions/39482131/is-it-possible-to-use-impl-trait-as-a-functions-return-type-in-a-trait-defini">Is
it possible to use <code>impl Trait</code> as a function&#8217;s return type in a trait
definition? - StackOverFlow</a></p>
</li>
<li>
<p><a id="gats"></a>[10] {{&lt; gh issue "rust-lang/rust" 4426 "Tracking issue for generic associated types (GAT)" &gt;}}</p>
</li>
<li>
<p><a id="gh-pkce"></a>[11] {{&lt; gh issue "ramsayleung/rspotify" 150 "Authorization Code Flow with Proof Key for Code Exchange (PKCE) is missing" &gt;}}</p>
</li>
<li>
<p><a id="str-param"></a>[12]
<a href="https://hermanradtke.com/2015/05/03/string-vs-str-in-rust-functions.html">String
vs &amp;str in Rust functions - hermanradtke.com</a></p>
</li>
<li>
<p><a id="gh-iterators"></a>[13] {{&lt; gh pr "ramsayleung/rspotify" 206 "Pass parameters by reference and use iterators wherever possible" &gt;}}</p>
</li>
<li>
<p><a id="gh-optional-params"></a>[14] {{&lt; gh issue "ramsayleung/rspotify" 134 "Optional parameters" &gt;}}</p>
</li>
<li>
<p><a id="gh-http-universal"></a>[15] {{&lt; gh issue "ramsayleung/rspotify" 234 "Use an external HTTP universal interface instead of `rspotify-http`" &gt;}}</p>
</li>
<li>
<p><a id="model-separation"></a>[16] {{&lt; gh pr "ramsayleung/rspotify" 191 "Move model into a separate rspotify-model crate" &gt;}}</p>
</li>
<li>
<p><a id="gh-aspotify-share"></a>[17] {{&lt; gh issue "KaiJewson/aspotify" 14 "Sharing the model with rspotify-model" &gt;}}</p>
</li>
<li>
<p><a id="gh-macros"></a>[18] {{&lt; gh pr "ramsayleung/rspotify" 202 "Remove RSpotify default parameters and add parameter macros" &gt;}}</p>
</li>
<li>
<p><a id="hashmap-new"></a>[19]
<a href="https://twitter.com/mgattozzi/status/1447983152669020160?t=jAGevaOOh___cWGERcLLgQ">New
hashmap constructor - @gmattozzi, Twitter</a></p>
</li>
<li>
<p><a id="gh-cleanup"></a>[20] {{&lt; gh issue "ramsayleung/rspotify" 108 "Reducing rspotify&#8217;s core dependencies" &gt;}}</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-16 13:42:11 +0200
</div>
</div>
</body>
</html>